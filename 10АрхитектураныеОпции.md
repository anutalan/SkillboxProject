---
## 10. Архитектурные опции

Решение: Микросервисная архитектура

## Обоснование выбора архитектруного стиля: 
- Для большой платормы на несколько стран, на весь мир) с большим количеством интеграций между компонентами данный подход самый подходящий и тем более если физически они будут развернуты даже в разных облаках. Тем более уже сейчас в разных странах, в разных облаках есть онлайн магазины и спортивные приложения бренда, с которыми тоже надо интегрироваться. Платформа должна работать в реальном времени с высокой нагрузкой на весь мир с множеством интеграций и социальной сетью для общения - удобное масштабирование микросервисов позволит обеспечить надежность и доступность платформы
- Независимость микросервисов позволит:
  - Разрабатывать и выпускать обновления и новые микросервисы без оставноки всей платформы (не нужно будет на 3 часа гасить всю платформу)  - получаем независимые релизы
  - Формировать команды из имеющего большого количества разработчиков по их локации, языку, скилам
  - Распределять микросервисы платформы можно достаточно легко по бизнесовым доменам среди получившихся команд и их технологий. 
     - Домены платформы
        - Пользователи и профили с настройками 
        - Тренировки
        - Подписки социальной сети
        - Уведомления
        - Интеграции с устройствами-датчиками
        - Интеграция с приложениями магазинов бренда
        - Новости
        - Рекомендации (аналитика ml)
  - Отдельные микросервисы возможно масштабировать отдельно в меру своей нагруженности.
  - Возможно для каждой задачи/ каждого сервиса использовать разные технологии
  - Легко заменять компоненты на новые, без рефакторинга - позволит заменить существующие приложения брендов в некоторых регионах

## Собственная разработка или вендоровская
| Критерии\ Разработка| Собственная | Вендоровская |
|---------| ---------| ---------|
| Владение кодом | Код точно будет собственностью нашей организации. | Код может являться собственностью вендрпра, для нас может являться скрытой коробкой|
| Скорость запуска | Медленная разработка с проектирования | Возможно, уже готов функционал и его можно интегрировать. Но возможно, что скорость поддержки доработок будет потом не такой быстрой. |
| Стоимость | В самом начале много надо вложить, потом поддерживать быстрее, без лишней волокиты | Стоимость в самом начале может быть небольшлая, а потом большой риск резкого роста контракта. |
| Экспертиза | Нужно держать сотрудников на поддержке и людей желательно в штате, кто знает данный функционал | Сильная зависимость от стабильности организации вендора и вовлеченности его сотрудников, они тоже могут меняться и экспертиза будет утеряна. |

Решение: так как есть свой штат разработки, то данной большой распределенной команде можно предложить данный проект, что не приведет к утере экспертизы в будущем. Сотрудники уже наняты и их увольнение (с выплатами) может быть даже дороже, чем запусить данный проект, используя данные ресурсы. Проектирование можно распараллелить по доменам и микрокомандам, и возможно, что вложенные ресурсы в самом начале окупятся, если не создавать зависимые связи с вендорами.
Компоненты, которые можно посмотреть на вендорном рынке: 
- аутентификация (вход по ID банка, по аккаунуту почты),
- уведомления, в том числе пуш и смс и по почте с использованием шаблонов 
- чат поддержки
- сеть CDN серверов для доставки контента
- возможности поддержки инфраструктуры облаков 

## Распределенность данных

| Данные|  Требование |
|---------| ---------|
| Данные о пользователе и его профиле| Создаются в БД и доступны в кэше через 5 секунд. Если даже две облачные инфраструктуры для одного региона имеют один IdP , то данные о новом пользователе должны сохраняться быстро и быть доступными для проверки авторизации сразу после сохранения. Данные профиля тоже доступны сразу, чтобы пользователь мог видеть только что введенные данные. |
|Данные с датчиков| Данные в фоновом вежиме постонно загружаются на платформу. Потоковая загрузка должна позволять получать данные почти неприрывно. Для нахождении в местности с плохим интернетом тренировки не должны прерываться.|
|Кэширование данных| Для быстрого доступа к контенту все новостные ленты кэшируются. В рамках одного цода, который соответствует определенному региону, кэш доступен быстрее, скажем чем данные из всей страны других основных цодов, но относящихся к другим регионам.|
|Реплицирование данных | Данные новостной ленты при создании попадают как в свою БД , так и в БД других регионов рекпликацией в рамках связанных основных цодов (одной юрисдикции). В цоды другой страны, например, данные не должны реплицироваться.|

## Технологический стек
| Стек|  Технология |
|---------| ---------|
| Фронтенд|  JavaScript\ Node.js BFF с делением api на mobile\ web|
| Бэкенд|  Java\ Spring boot, Python для ML |
| Очереди|  Kafka - потоковая обработка данных|
| Кэш|  Radis - для постов, токенов |
| Мониторинг|  Prometheos, Grafana |
| Протоколы безопасности|  OAuth 2.0 +  OAuth 2.0 Token Exchange + App Firewall |
| Кэш|  Radis - для постов, токенов |
| Контейнеризация|  Kubernetes |

## Типы базы данных
| БД|  Требование | Данные|
|---------| ---------| ---------|
| SQL|  PostgreSQL | Основная БД с реляцией и транзакциями. Трекинговые данные, агрегация по интервалам этих данных. |
| NoSQL |  MongoDB | Json cхемы постов, мероприятий, условий геймификации. Файлы с контентом аудио, видео, фото|
| Графовая |  Neo4J | Данные из социльной связей о подписках, рекомендациях, лайках, друзьях |

## Принципы развертывания инфрастраструктуры
- Выделение отдельного цода основывается на масштабах региона, единых юрисдикциях, - строим инфраструктуру с изолированными географически распределенными цодами
  - Если есть несколько цодов для разных регионов одной страны с единой юрисдикции, то они могут иметь один сервис аутентификации. А данные о токенах кэшируются в каждом цоде отдельно после получения токена пользователем.
- Некритичные сервисы для цодов с единой юрисдикцией можно централизовать в одном из цодов. Например, сервис анилитики BI\ML, который будет собирать все данные со всех цодов и создавать рекомендации.
  - Все данные для аналитики попадают в единое общее хранилище из разных цодов разной юрисдикции только в ананимизированном виде или агрегированном.
  - Данные из встроенных трекинговых хранилищ Android и IoS могут быть не полностью сохраняться на платформе, поскольку эти сервисы можно использовать как хранилища и за этими данными можно повторно туда сходить.
- Пользователи не могут полностью использовать инфраструктуру цода другой юрисдикции\ домена, возможно только предоставить доступ к новостной ленте, но в ограниченном режиме чтения с использованием token exchange.

 Уровни развертывания:
1) CDN сервер
2) Api Gateway
3) Сервисы BFF c ветвлением на сервисы мобильного приложения и web версий пользователей, администраторов
4) Сервис авторизации
5) Сервисы ядра (Пользователи, Тренировок, Уведомлений, Социальной сети, Новостей и рекламы)
6) Каш
7) Кластер базы данных
8) Кластер Kafka
9) Аналитика BI\ML
 
